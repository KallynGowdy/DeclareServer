# Pipeline

Here is the request pipeline:

    +----------------+  +--------------+   +--------------+   +---------------+
    |                |  |              |   |              |   |               |
    |    Request     |  |  Middleware  +--->    Router    +---> Authorization |
    |                |  |              | 3 |              | 4 |               |
    +-------+--------+  +------^-------+   +------^-------+   +---------------+
          1 |                  |                  |                  5|        
            |                  |                  |           +-------v-------+
            |                  |                  |6          |               |
    +-------v--------+       2 |                  +-----------+    Content    |
    |                +---------+                              |               |
    | Authentication |                                        +---------------+
    |                <---------+                                     7|        
    +-------+--------+      10 |                              +-------v-------+
         11 |                  |                              |               |
            |                  |                              | Authorization |
            |                  |                              |               |
            |                  |                              +---------------+
            |                  |                                     8|        
    +-------v--------+  +------+-------+                      +-------v-------+
    |                |  |              |         9            |               |
    |    Response    |  |  Middleware  <----------------------+    Service    |
    |                |  |              |                      |               |
    +----------------+  +--------------+                      +---------------+

1. The request is received from the client.
2. The identity of the client is determined.
3. Middleware is run on the request.
4. The router determines what content should be retrieved
5. The request is checked for authorization to access the content
6. More content is retrieved as needed based on the route
7. The request is once again checked for authorization, but this time for the ability to
perform the requested operation in the service.
8. The request is processed, the content is manipulated and a response is generated by the service.
9. Middleware is run on the response.
10. The identity of the client is optionally provided to the client. (in the case of signing in)
11. The response is sent to the client.


## Overview

Servant is built on top of [OWIN](http://owin.org/). Along with that, Servant is designed to accommodate a pipeline that encourages manipulating data through a simple step-by-step process. As you can see from the diagram above, Servant takes eleven major steps to responding to a request.

### Authentication

The identity of the client is determined as the first step in the process. Essentially, this step exists to retrieve whatever credentials, if any, that the client possesses that prove that it is who it says it is.

### Middleware

Middleware runs before and after every specified request. How this affects the application is up to you, but middleware allows you to decide whether to handle a request using Servant or something else, or you could use it to manipulate an incoming request. Middleware is usually a good place to put code that affects large parts of the web application that have cross cutting concerns. See [OWIN Middleware in the IIS integrated pipeline](http://www.asp.net/aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline) for some more detail on OWIN and OWIN Middleware.

### Router

[Full Article](./routing.md)

The router is used to determine the pathway through the application's code. In Servant, this means determining the content and controller endpoints to hit. Which sections are hit is determined by the configuration, but a rigged install of Serviced will provide most of that for you.

### Content

Content modules control what data is retrieved from the database. They are in charge of defining what data they are able to retrieve and in charge of getting that data in the context of a request. Content modules are also in charge of defining which permissions a user needs to have in order to access the data, if any. Those requirements are then used to determine whether the content should be retrieved or not.

There are several benefits to including content retrieval in the request pipeline:

1. First, it allows you to define strong authorization requirements on specific pieces of data in the application. This is very important when making sure that data is not accidentally exposed or manipulated.
2. Second, it provides a normalized interface to your database. This is important when sharing data across services.
3. Third, it makes resource based routing a cinch. Content modules can filter data based on the request and previous content modules, meaning that getting all of the pets for a user while using the same module for all of the pets in a building is easy to implement in a DRY fashion.
4. Fourth, it just makes sense. Separate the data logic from the business logic.

### Authorization

There are two logical steps to the authorization of the request.

The first step checks to see if the client is even able to access the content based on its authenticated permissions. The benefits that this step provides include a consistent set of rules required to access and manipulate content that can be shared across all services.

The second step checks to see if the client is able to perform the requested action based on its authenticated permissions. The benefits that this step provides include a fine grain control over the who, what, when, where, and why a client is allowed to access and manipulate content in a specific way.

In reality, those two steps are often condensed into one single check that is run before any content or services are hit for performance considerations.

### Services

Services are in charge of defining the interactions that can be made on content and how they are exposed to the outside world. Services determine how content is able to be manipulated and what Authorization rules apply to those manipulations.

Services are designed to be agnostic of requests and responses, allowing a Serviced app to be run on more than just the web, enabling potential reuse of code across platforms.
